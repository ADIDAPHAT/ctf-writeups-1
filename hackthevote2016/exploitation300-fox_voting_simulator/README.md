# FOX Voting Simulator - Exploitation - 300 points

> In primaries, it is important to get the most attention. With 12 candidates all sharing the stage, it can be hard to pull in voters. Luckily Mr Trump doesn't have much problem with that, but we have a strategy to secure the vote for good. We have found voters respond very well to name recognition, and which ever candidate is polling the highest. We see a snowball effect if we can tip a few online polls his way, then it will be easier for him to take the real ones, and then eventually the nomination.
> 
> We were able to dump some of the source code from FOX's new online poll service. We couldn't get everything, but I'm sure that is no problem for you.
> 
> foxSim
> 
> nc fox.pwn.republican 9000
> 
> author's irc nick: itszn
> 
> Great, thanks to your help, Mr Trump is smashing all the new polls, and gaining momentum. And everyone said he couldn't do it!

Only source code is provided, so we don't know the layout of the binary. So first we need to find a way to dump memory. The
first flaw found is that if you create a new user, then vote for yourself, your vote count won't be reset to 0 or 1, and
`voteForWriteIn` will still be called with the vote count your specified. This function then treats your vote count as a
memory address and will print a previously set message if the memory address is below `main`, but will print whatever is on
that address if it is higher or equal to `main`. By repeatedly exploiting this flaw, we can dump the part of the binary from
`main` and upwards, which will give us some memory offsets and more info about what the mysterious `NWO_memberVote` actually
does.

After dumping most of the binary, it seems like `NWO_memberVote` doesn't do that much interesting - it sets a message, then
adds the number of votes minus one to the specified user. But wait - the struct for non-candidates doesn't have a vote
field! What happens if we give them votes?

Turns out if you have two non-candidate person structs next to each other in memory, the vote field of the first person,
when cast to a candidate, overlaps the `action` field of the second person. This should in theory give RIP control, the only
thing left is to figure out how to vote as a candidate, because those are the only ones that can vote for non-candidates.
This is easy enough since the hash map of persons/candidates only has 100 entries so it's easy to generate a collision. The
full process now is:

* Create the user `test`, then vote for anyone (Doesn't matter)
* Create the user `test2`, then vote for anyone (Doesn't matter). `test2` now is placed after `test` on the heap
* Log in as a candidate, for example `DrumpfN`, then vote for `test` which will overwrite into `test2` - note that you can only _add_ votes, so you need to take in account the already existing value of the `action` function pointer for `test2`
* Log in as `test2`, then vote for yourself. The number of votes is the second function parameter that goes into `RSI` when calling the function at `action`

There's a nice small gadget at `0x400a00` which does `mov rdi, rsi; jmp printf` which is perfect for us - it moves the
second parameter into the first, which then allows us to dump memory from anywhere in the system. It also doesn't corrupt
any memory or stack, so it can be used repeatedly by continuing voting for `test2`. Dumping the GOT gives us the address of
`libc`, and we can then search downwards in memory until we hit the ELF header. Then we can dump until we hit the GNU
BuildID, which allows us to search for the correct `libc` file without dumping it piece by piece.

`nc fox.pwn.republican 22` gives us the SSH banner `SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.1` gives a hint about what version
they're using, and after a bit of searching we find [the correct libc version](http://packages.ubuntu.com/xenial-updates/amd64/libc6/download). It is now only a matter of finding a working
[one-gadget /bin/sh RCE](https://kimiyuki.net/blog/2016/09/16/one-gadget-rce-ubuntu-1604/) somewhere in the library.

Then it's just a matter of calling the gadget, do `cat flag.txt` and we get the flag `flag{R3sr1ct_y0ur_s3lf_T0_s0uRce_0nly_4nD_y0u_w1ll_l3ak_a_l0t}`
